---
# Playbook: Backup Network Devices
# Description: Backup running configuration from all network devices

- name: Backup Network Device Configurations
  hosts: network
  gather_facts: false

  vars:
    backup_dir: "/ansible/backups"
    backup_timestamp: "{{ lookup('pipe', 'date +%Y%m%d_%H%M%S') }}"

  tasks:
    - name: Create backup directory
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
      tags:
        - backup

    - name: Backup Cisco IOS configuration
      cisco.ios.ios_config:
        backup: true
        backup_options:
          filename: "{{ inventory_hostname }}_{{ backup_timestamp }}.cfg"
          dir_path: "{{ backup_dir }}"
      when: ansible_network_os == 'cisco.ios.ios'
      tags:
        - backup

    - name: Backup switch configuration via CLI
      ansible.netcommon.cli_command:
        command: "show running-config"
      register: switch_config
      when: "'switches' in group_names"
      tags:
        - backup

    - name: Save switch configuration to file
      ansible.builtin.copy:
        content: "{{ switch_config.stdout }}"
        dest: >-
          {{ backup_dir }}/{{ inventory_hostname }}_{{ backup_timestamp }}.cfg
        mode: '0644'
      delegate_to: localhost
      when: "'switches' in group_names and switch_config is defined"
      tags:
        - backup
